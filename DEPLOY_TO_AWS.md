# Next.js & Prisma アプリケーションをAWSにデプロイする手順

このドキュメントでは、このNext.jsアプリケーションをAWSのマネージドサービスである **AWS Amplify Hosting** と **Amazon RDS for PostgreSQL** を利用してデプロイする手順を説明します。

## 推奨アーキテクチャ

- **フロントエンド (Next.js)**: **AWS Amplify Hosting**
  - Next.jsのホスティングに最適化されており、CI/CDパイプラインを簡単に構築できます。
- **データベース (PostgreSQL)**: **Amazon RDS for PostgreSQL**
  - フルマネージドなリレーショナルデータベースサービスです。

---

## ステップ1: AWSでPostgreSQLデータベースを準備する (Amazon RDS)

1.  **RDSインスタンスの作成**:
    - AWSマネジメントコンソールにログインし、RDSのサービスページに移動します。
    - 「データベースの作成」をクリックします。
    - エンジンタイプとして「**PostgreSQL**」を選択します。
    - テンプレートで「**無料利用枠**」を選択すると、開発・テスト中のコストを抑えられます（本番環境では適切なスペックを選択してください）。
    - **設定**:
        - **DBインスタンス識別子**: 任意の名前（例: `disaster-prep-db`）
        - **マスターユーザー名**: 任意のユーザー名（例: `postgres`）
        - **マスターパスワード**: 強力なパスワードを設定します。
    - **接続**:
        - **重要**: 「パブリックアクセス」を一時的に「**あり**」に設定します。これにより、後のステップでデータベーススキーマのマイグレーションが容易になります。（本番稼働時にはセキュリティ向上のため無効化を推奨します）。
    - 上記以外はデフォルト設定のままで、「データベースの作成」をクリックします。作成には数分かかります。

2.  **データベース接続情報 (`DATABASE_URL`) の取得**:
    - 作成したデータベースの詳細ページを開き、「エンドポイントとポート」セクションから**エンドポイント**の値をコピーします。
    - 以下の形式で接続文字列 (`DATABASE_URL`) を作成します。この値は後のステップで何度も使用します。
      ```
      postgresql://<マスターユーザー名>:<マスターパスワード>@<エンドポイント>:5432/<データベース名>
      ```
      - `<データベース名>`は作成時に指定したもので、デフォルトは `postgres` です。

---

## ステップ2: PrismaスキーマをRDSに適用する

Amplifyでデプロイする前に、作成したRDSデータベースにテーブルを作成しておく必要があります。

1.  **ローカル環境の設定変更**:
    - プロジェクトのルートにある `.env` ファイル（なければ作成）に、ステップ1で作成した `DATABASE_URL` を設定します。
      ```.env
      DATABASE_URL="postgresql://<ユーザー名>:<パスワード>@<RDSのエンドポイント>:5432/postgres"
      ```

2.  **データベースマイグレーションの実行**:
    - ターミナルで以下のコマンドを実行し、PrismaのスキーマをRDSデータベースに適用します。
      ```bash
      npx prisma migrate deploy
      ```
    - このコマンドは `prisma/migrations` ディレクトリにあるマイグレーション履歴をデータベースに適用します。

3.  **設定の復元**:
    - マイグレーションが完了したら、`.env` ファイルの内容をローカル開発用の設定に戻すか、削除しておきましょう。

---

## ステップ3: AWS AmplifyでNext.jsアプリケーションをデプロイする

1.  **コードをGitリポジトリにプッシュ**:
    - まだの場合、このプロジェクトのコードをGitHub, GitLab, BitbucketなどのGitリポジトリにプッシュしてください。Amplifyはこれらのリポジトリと連携して自動デプロイを実現します。

2.  **Amplifyアプリケーションの作成**:
    - AWSマネジメントコンソールでAmplifyのサービスページに移動します。
    - 「新しいアプリケーションをホスト」から「ウェブアプリケーションをホスト」を選択します。
    - Gitプロバイダー（GitHubなど）を選択し、リポジトリとブランチ（例: `main`）を選択して接続します。

3.  **ビルド設定の構成**:
    - Amplifyが自動でビルド設定を検出しますが、いくつか手動で変更する必要があります。「ビルド設定」のセクションで「編集」をクリックします。
    - **環境変数**:
        - 「環境変数を追加」をクリックし、以下の変数を設定します。
            - **変数**: `DATABASE_URL`
            - **値**: ステップ1で作成したRDSの接続文字列
    - **ビルド設定 (amplify.yml)**:
        - `build` コマンドの前に `prisma generate` を追加する必要があります。これにより、ビルド時にPrisma Clientが生成されます。
        - 以下は `amplify.yml` の設定例です。`pnpm` を使用していることを前提としています。

        ```yaml
        version: 1
        backend:
          phases:
            build:
              commands:
                - '# Execute AmplifyCi - DO NOT REMOVE'
                - npx AmplifyCi --npm
        frontend:
          phases:
            preBuild:
              commands:
                - npm install -g pnpm
                - pnpm install
                - npx prisma generate
            build:
              commands:
                - pnpm run build
          artifacts:
            baseDirectory: .next
            files:
              - '**/*'
          cache:
            paths:
              - node_modules/**/*
              - .next/cache/**/*
        ```

4.  **確認とデプロイ**:
    - 設定を保存し、次の画面で内容を確認して「保存してデプロイ」をクリックします。
    - Amplifyがプロビジョニング、ビルド、デプロイを実行します。これには数分かかります。
    - デプロイが完了すると、アプリケーションにアクセスするためのURLが提供されます。

---

## （推奨）本番環境向けのセキュリティ設定

デプロイが成功したら、セキュリティを強化するためにRDSデータベースへのパブリックアクセスを無効にすることを強く推奨します。

- **RDSのパブリックアクセスを無効化**:
  - RDSインスタンスの「変更」ページで、「接続」セクションの「パブリックアクセス」を「**なし**」に変更します。
- **VPC接続**:
  - AmplifyとRDSを同じVPC内に配置し、VPCエンドポイント経由で接続するように設定します。これにより、インターネットを経由しないセキュアな通信が可能になります。この設定は高度な内容を含むため、AWSのドキュメントを参照してください。
